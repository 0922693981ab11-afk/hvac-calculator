<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HVAC 工程萬用計算機 Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .tab-btn.active { background-color: #2563eb; color: white; border-color: #2563eb; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .gauge-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen pb-20">

    <!-- Navbar -->
    <div class="bg-blue-900 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="max-w-3xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold flex items-center gap-2">
                    <i class="fa-solid fa-helmet-safety"></i> 工程萬用計算機
                </h1>
                <p class="text-xs text-blue-300 ml-8 font-medium tracking-wide">(設計者: 吳啓仲)</p>
            </div>
            <span class="text-xs bg-blue-700 px-2 py-1 rounded text-blue-100">Ver 3.1</span>
        </div>
    </div>

    <div class="max-w-3xl mx-auto p-4">

        <!-- Navigation Tabs -->
        <div class="grid grid-cols-4 gap-2 mb-6 text-sm font-medium text-gray-500">
            <button onclick="switchTab('tab-dim')" id="btn-tab-dim" class="tab-btn active bg-white border border-gray-200 rounded-lg p-2 text-center shadow-sm hover:bg-gray-50 transition-all flex flex-col items-center gap-1">
                <i class="fa-solid fa-ruler-combined text-lg"></i>
                <span>尺寸</span>
            </button>
            <button onclick="switchTab('tab-duct')" id="btn-tab-duct" class="tab-btn bg-white border border-gray-200 rounded-lg p-2 text-center shadow-sm hover:bg-gray-50 transition-all flex flex-col items-center gap-1">
                <i class="fa-solid fa-scroll text-lg"></i>
                <span>鐵皮</span>
            </button>
            <button onclick="switchTab('tab-air')" id="btn-tab-air" class="tab-btn bg-white border border-gray-200 rounded-lg p-2 text-center shadow-sm hover:bg-gray-50 transition-all flex flex-col items-center gap-1">
                <i class="fa-solid fa-wind text-lg"></i>
                <span>風量</span>
            </button>
            <button onclick="switchTab('tab-motor')" id="btn-tab-motor" class="tab-btn bg-white border border-gray-200 rounded-lg p-2 text-center shadow-sm hover:bg-gray-50 transition-all flex flex-col items-center gap-1">
                <i class="fa-solid fa-bolt text-lg"></i>
                <span>馬達</span>
            </button>
        </div>

        <!-- TAB 1: 尺寸速算 -->
        <div id="tab-dim" class="tab-content active space-y-4">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-blue-50 p-4 border-b border-blue-100 flex justify-between items-center">
                    <h2 class="font-bold text-blue-800">W+D+L 尺寸/材積速算</h2>
                    <div class="flex bg-white rounded-md border border-blue-200 p-1">
                        <button onclick="setDimUnit('mm')" id="dim-btn-mm" class="px-2 py-1 text-xs rounded transition-colors">mm</button>
                        <button onclick="setDimUnit('cm')" id="dim-btn-cm" class="px-2 py-1 text-xs rounded bg-blue-600 text-white shadow-sm">cm</button>
                        <button onclick="setDimUnit('m')" id="dim-btn-m" class="px-2 py-1 text-xs rounded transition-colors">M</button>
                    </div>
                </div>
                <div class="p-5 space-y-5">
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">W (寬)</label>
                            <input type="number" id="dim-w" oninput="calcDim()" placeholder="0" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-3 text-center text-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">D (深)</label>
                            <input type="number" id="dim-d" oninput="calcDim()" placeholder="0" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-3 text-center text-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">L (長)</label>
                            <input type="number" id="dim-l" oninput="calcDim()" placeholder="0" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-3 text-center text-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                            <div class="text-xs text-indigo-500 font-bold mb-1">總和 (W+D+L)</div>
                            <div class="flex justify-between items-center">
                                <div id="dim-res-sum" class="text-3xl font-bold text-indigo-700">0.000</div>
                                <span class="text-xs text-indigo-400 bg-white px-2 py-1 rounded">公尺 M</span>
                            </div>
                        </div>
                        <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                            <div class="text-xs text-emerald-500 font-bold mb-1">材積 (Volume)</div>
                            <div class="flex justify-between items-center">
                                <div id="dim-res-cbm" class="text-2xl font-bold text-emerald-700">0.000</div>
                                <span class="text-xs text-emerald-500">CBM (m³)</span>
                            </div>
                        </div>
                    </div>
                    <button onclick="resetDim()" class="w-full py-2 text-gray-400 hover:text-gray-600 text-sm flex items-center justify-center gap-2">
                        <i class="fa-solid fa-rotate-right"></i> 重置
                    </button>
                </div>
            </div>
        </div>

        <!-- TAB 2: 風管鐵皮 (升級版) -->
        <div id="tab-duct" class="tab-content space-y-4">
            <!-- Input Section -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-gray-800 text-white p-4 flex justify-between items-center">
                    <h2 class="font-bold"><i class="fa-solid fa-scroll mr-2"></i>鐵皮計算</h2>
                    <span class="text-xs text-gray-400">公式：(W+H)×2×L</span>
                </div>
                <div class="p-4 space-y-4">
                    <!-- Gauge Reference -->
                    <div id="gauge-ref" class="hidden bg-yellow-50 text-yellow-800 text-xs p-2 rounded border border-yellow-200 flex items-center gap-2 mb-2">
                        <i class="fa-regular fa-lightbulb"></i> 建議番號：<span id="gauge-val" class="font-bold text-sm">--</span>
                        <span class="text-gray-400 scale-75">(依長邊尺寸推算)</span>
                    </div>

                    <div class="grid grid-cols-3 gap-3">
                        <div class="col-span-1">
                            <label class="block text-xs font-bold text-gray-500 mb-1">寬 W (cm)</label>
                            <input type="number" id="duct-w" oninput="calcDuctSingle()" placeholder="0" class="w-full p-2 bg-gray-50 border border-gray-300 rounded text-center focus:ring-2 focus:ring-gray-500 outline-none">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-xs font-bold text-gray-500 mb-1">高 H (cm)</label>
                            <input type="number" id="duct-h" oninput="calcDuctSingle()" placeholder="0" class="w-full p-2 bg-gray-50 border border-gray-300 rounded text-center focus:ring-2 focus:ring-gray-500 outline-none">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-xs font-bold text-gray-500 mb-1">長 L (M)</label>
                            <input type="number" id="duct-l" oninput="calcDuctSingle()" placeholder="0" class="w-full p-2 bg-gray-50 border border-gray-300 rounded text-center focus:ring-2 focus:ring-gray-500 outline-none">
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-3 items-end">
                         <div class="col-span-2">
                            <label class="block text-xs font-bold text-gray-500 mb-1">備註 (選填)</label>
                            <input type="text" id="duct-remark" placeholder="例: 客廳, 1F幹線" class="w-full p-2 bg-gray-50 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-gray-500 outline-none">
                        </div>
                        <div class="col-span-1">
                             <label class="block text-xs font-bold text-gray-500 mb-1">損耗率(%)</label>
                             <input type="number" id="duct-loss" value="12" oninput="calcDuctSingle()" class="w-full p-2 bg-gray-50 border border-gray-300 rounded text-center text-sm">
                        </div>
                    </div>

                    <!-- Single Calculation Preview -->
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 flex justify-between items-center">
                        <div class="text-xs text-gray-600">
                            單筆面積: <span id="duct-single-area" class="font-bold text-gray-800">0.00</span> m²
                        </div>
                        <button onclick="addDuctItem()" class="bg-gray-800 text-white px-4 py-1.5 rounded text-xs font-bold hover:bg-black transition-colors flex items-center gap-1">
                            <i class="fa-solid fa-plus"></i> 加入清單
                        </button>
                    </div>
                </div>
            </div>

            <!-- List Section -->
            <div id="duct-list-container" class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden hidden">
                <div class="bg-gray-100 p-2 text-xs font-bold text-gray-600 flex justify-between px-4">
                    <span>統計清單</span>
                    <button onclick="clearDuctList()" class="text-red-500 hover:text-red-700">清空</button>
                </div>
                <div id="duct-list-body" class="p-0 divide-y divide-gray-100 max-h-60 overflow-y-auto">
                    <!-- Dynamic Items Here -->
                </div>
                
                <!-- Total Footer -->
                <div class="bg-orange-50 p-4 border-t border-orange-200">
                    <div class="flex justify-between items-end mb-3">
                        <span class="text-orange-900 font-bold text-sm">總面積 (含損耗)</span>
                        <span class="text-2xl font-bold text-orange-700"><span id="duct-total-area">0.00</span> <span class="text-sm">m²</span></span>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white p-2 rounded border border-orange-100 text-center shadow-sm">
                            <div class="text-xs text-gray-500 mb-1">3' x 7' 總張數</div>
                            <div id="duct-total-3x7" class="text-xl font-bold text-gray-800">0</div>
                        </div>
                        <div class="bg-white p-2 rounded border border-orange-100 text-center shadow-sm">
                            <div class="text-xs text-gray-500 mb-1">4' x 8' 總張數</div>
                            <div id="duct-total-4x8" class="text-xl font-bold text-gray-800">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 3: 風量計算 (升級版) -->
        <div id="tab-air" class="tab-content space-y-4">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-sky-600 text-white p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="font-bold"><i class="fa-solid fa-wind mr-2"></i>排煙/風量計算</h2>
                    </div>
                    
                    <!-- Mode Switch -->
                    <div class="flex bg-sky-700 p-1 rounded-lg">
                        <button onclick="setAirMode('single')" id="air-btn-single" class="flex-1 py-1.5 text-xs rounded-md bg-white text-sky-700 font-bold shadow-sm transition-all">單區計算</button>
                        <button onclick="setAirMode('multi')" id="air-btn-multi" class="flex-1 py-1.5 text-xs rounded-md text-sky-100 hover:text-white transition-all">多區合併</button>
                    </div>
                    
                    <!-- Largest Zone Checkbox -->
                    <div class="mt-3 flex items-center gap-2">
                        <input type="checkbox" id="air-is-max" onchange="calcAir()" class="w-4 h-4 text-sky-600 rounded border-gray-300 focus:ring-sky-500">
                        <label for="air-is-max" class="text-xs text-sky-50 select-none cursor-pointer">
                            最大一區 <span class="opacity-75">(單區模式x2 / 多區模式為加總)</span>
                        </label>
                    </div>
                </div>

                <div class="p-4 space-y-4">
                    
                    <!-- MODE: SINGLE ZONE -->
                    <div id="air-content-single">
                        <!-- Area Input -->
                        <div class="bg-sky-50 p-3 rounded-lg mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-xs font-bold text-sky-800">風口尺寸 / 面積</label>
                                <span class="text-[10px] text-sky-600 bg-white px-2 py-0.5 rounded border border-sky-100">Q = V × A</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <input type="number" id="air-s-w" oninput="calcAir()" placeholder="寬 W (cm)" class="p-2 border border-gray-300 rounded text-center text-sm">
                                <input type="number" id="air-s-h" oninput="calcAir()" placeholder="高 H (cm)" class="p-2 border border-gray-300 rounded text-center text-sm">
                            </div>
                            <div class="text-right text-xs text-gray-400">或直接輸入面積: <input type="number" id="air-s-area" oninput="calcAir()" placeholder="m²" class="w-20 border-b border-gray-300 bg-transparent text-center focus:outline-none"> m²</div>
                        </div>

                        <!-- 5 Point Velocity -->
                        <div class="mb-4">
                            <label class="block text-xs font-bold text-gray-500 mb-2">五點風速 (m/s)</label>
                            <div class="grid grid-cols-5 gap-2">
                                <input type="number" class="air-s-v p-2 border border-gray-300 rounded text-center text-sm" placeholder="1" oninput="calcAir()">
                                <input type="number" class="air-s-v p-2 border border-gray-300 rounded text-center text-sm" placeholder="2" oninput="calcAir()">
                                <input type="number" class="air-s-v p-2 border border-gray-300 rounded text-center text-sm" placeholder="3" oninput="calcAir()">
                                <input type="number" class="air-s-v p-2 border border-gray-300 rounded text-center text-sm" placeholder="4" oninput="calcAir()">
                                <input type="number" class="air-s-v p-2 border border-gray-300 rounded text-center text-sm" placeholder="5" oninput="calcAir()">
                            </div>
                            <div class="text-center mt-2 text-xs text-gray-500">平均風速: <span id="air-s-avg" class="font-bold text-gray-800">0.0</span> m/s</div>
                        </div>
                    </div>

                    <!-- MODE: MULTI ZONE -->
                    <div id="air-content-multi" class="hidden">
                        <div class="text-xs text-gray-500 mb-2 flex justify-between items-center">
                            <span>各分區資料 (尺寸/風速)</span>
                            <button onclick="addMultiRow()" class="text-sky-600 font-bold hover:underline">+ 新增區域</button>
                        </div>
                        
                        <div id="air-multi-rows" class="space-y-2">
                            <!-- Rows injected by JS -->
                        </div>
                    </div>

                    <hr class="border-gray-100">

                    <!-- RESULT DISPLAY -->
                    <div class="bg-sky-100 p-4 rounded-xl text-center border border-sky-200">
                        <div class="text-xs text-sky-700 font-bold mb-1" id="air-result-label">計算風量 (CMM)</div>
                        <div class="flex justify-center items-baseline gap-2">
                            <span id="air-final-flow" class="text-3xl font-bold text-sky-900">0.0</span>
                            <span class="text-sm text-sky-700">m³/min</span>
                        </div>
                        <div id="air-factor-msg" class="text-[10px] text-red-500 font-bold mt-1 hidden">
                            <i class="fa-solid fa-check"></i> 已乘 2 倍 (最大一區)
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- TAB 4: 馬達電氣 -->
        <div id="tab-motor" class="tab-content space-y-4">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-yellow-600 text-white p-4">
                    <h2 class="font-bold"><i class="fa-solid fa-bolt mr-2"></i>馬達額定電流速查</h2>
                    <p class="text-xs text-yellow-100 mt-1">資料來源：電動機額定電流表</p>
                </div>
                <div class="p-5">
                    <div class="flex gap-4 mb-6">
                        <div class="w-1/2">
                            <label class="block text-xs font-bold text-gray-500 mb-1">馬力 (HP)</label>
                            <select id="motor-hp" onchange="lookupMotor()" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg outline-none">
                                <option value="1">1 HP</option>
                                <option value="2">2 HP</option>
                                <option value="3">3 HP</option>
                                <option value="5" selected>5 HP</option>
                                <option value="7.5">7.5 HP</option>
                                <option value="10">10 HP</option>
                                <option value="15">15 HP</option>
                                <option value="20">20 HP</option>
                                <option value="25">25 HP</option>
                                <option value="30">30 HP</option>
                                <option value="35">35 HP</option>
                                <option value="40">40 HP</option>
                                <option value="50">50 HP</option>
                            </select>
                        </div>
                        <div class="w-1/2">
                            <label class="block text-xs font-bold text-gray-500 mb-1">電壓 (V)</label>
                            <select id="motor-v" onchange="lookupMotor()" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg outline-none">
                                <option value="220">3相 220V</option>
                                <option value="380">3相 380V</option>
                                <option value="440">3相 440V</option>
                            </select>
                        </div>
                    </div>

                    <div class="bg-yellow-50 rounded-xl p-6 border border-yellow-200 text-center relative">
                        <div class="text-sm text-yellow-800 font-bold mb-2">滿載電流 (Full Load Current)</div>
                        <div class="flex justify-center items-baseline gap-2">
                            <span id="motor-amp" class="text-5xl font-bold text-yellow-600">--</span>
                            <span class="text-xl text-yellow-600 font-medium">A</span>
                        </div>
                        <div class="mt-4 pt-4 border-t border-yellow-200">
                            <p class="text-xs text-gray-500">
                                <i class="fa-solid fa-circle-info mr-1"></i>
                                參考線徑 (依 CNS 標準估算)：
                            </p>
                            <div id="motor-wire" class="text-sm font-bold text-gray-700 mt-1">
                                --
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- Tab System ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('active', 'bg-blue-600', 'text-white', 'border-blue-600');
                el.classList.add('bg-white', 'text-gray-500', 'border-gray-200');
            });
            const activeBtn = document.getElementById('btn-' + tabId);
            activeBtn.classList.remove('bg-white', 'text-gray-500', 'border-gray-200');
            activeBtn.classList.add('active');
        }

        // --- 1. Dimension Logic ---
        let dimUnit = 'cm';
        function setDimUnit(unit) {
            dimUnit = unit;
            document.querySelectorAll('#tab-dim button').forEach(b => {
                b.className = 'px-2 py-1 text-xs rounded transition-colors';
            });
            const btn = document.getElementById(`dim-btn-${unit}`);
            btn.className = 'px-2 py-1 text-xs rounded bg-blue-600 text-white shadow-sm';
            calcDim();
        }

        function calcDim() {
            const w = parseFloat(document.getElementById('dim-w').value) || 0;
            const d = parseFloat(document.getElementById('dim-d').value) || 0;
            const l = parseFloat(document.getElementById('dim-l').value) || 0;
            
            let factor = 1;
            if(dimUnit === 'mm') factor = 0.001;
            if(dimUnit === 'cm') factor = 0.01;
            
            const wM = w * factor;
            const dM = d * factor;
            const lM = l * factor;

            const sum = wM + dM + lM;
            const cbm = wM * dM * lM;

            document.getElementById('dim-res-sum').innerText = sum.toFixed(3);
            document.getElementById('dim-res-cbm').innerText = cbm.toFixed(3);
        }

        function resetDim() {
            document.getElementById('dim-w').value = '';
            document.getElementById('dim-d').value = '';
            document.getElementById('dim-l').value = '';
            calcDim();
        }

        // --- 2. Duct Logic ---
        let ductList = [];

        function getGauge(sizeCm) {
            // sizeCm is the max dimension of W or H
            const sizeMm = sizeCm * 10;
            if (sizeMm <= 750) return "#26~#24 (0.5/0.6)";
            if (sizeMm <= 1500) return "#22 (0.8)";
            if (sizeMm <= 2250) return "#20 (1.0)";
            return "#18 (1.2)";
        }

        function calcDuctSingle() {
            const w = parseFloat(document.getElementById('duct-w').value) || 0;
            const h = parseFloat(document.getElementById('duct-h').value) || 0;
            const l = parseFloat(document.getElementById('duct-l').value) || 0;
            const loss = parseFloat(document.getElementById('duct-loss').value) || 0;

            const maxDim = Math.max(w, h);
            const gaugeEl = document.getElementById('gauge-ref');
            const gaugeVal = document.getElementById('gauge-val');
            if(maxDim > 0) {
                gaugeEl.classList.remove('hidden');
                gaugeVal.innerText = getGauge(maxDim);
            } else {
                gaugeEl.classList.add('hidden');
            }

            const perimeterM = (w + h) * 2 / 100;
            const rawArea = perimeterM * l;
            const totalArea = rawArea * (1 + loss/100);

            document.getElementById('duct-single-area').innerText = totalArea.toFixed(2);
        }

        function addDuctItem() {
            const w = parseFloat(document.getElementById('duct-w').value) || 0;
            const h = parseFloat(document.getElementById('duct-h').value) || 0;
            const l = parseFloat(document.getElementById('duct-l').value) || 0;
            const loss = parseFloat(document.getElementById('duct-loss').value) || 0;
            const remark = document.getElementById('duct-remark').value || '-';

            if(w === 0 || h === 0 || l === 0) return;

            const perimeterM = (w + h) * 2 / 100;
            const area = perimeterM * l * (1 + loss/100);
            const gauge = getGauge(Math.max(w, h)).split(' ')[0];

            ductList.push({
                remark: remark,
                dim: `${w}x${h}`,
                len: l,
                area: area,
                gauge: gauge
            });

            renderDuctList();
            
            document.getElementById('duct-w').value = '';
            document.getElementById('duct-h').value = '';
            document.getElementById('duct-l').value = '';
            document.getElementById('duct-remark').value = '';
            calcDuctSingle();
        }

        function renderDuctList() {
            const container = document.getElementById('duct-list-container');
            const body = document.getElementById('duct-list-body');
            
            if(ductList.length > 0) container.classList.remove('hidden');
            else container.classList.add('hidden');

            body.innerHTML = '';
            let totalArea = 0;

            ductList.forEach((item, index) => {
                totalArea += item.area;
                const row = document.createElement('div');
                row.className = 'p-3 flex justify-between items-center group';
                row.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-gray-700 text-sm">${item.remark}</span>
                            <span class="gauge-badge">${item.gauge}</span>
                        </div>
                        <div class="text-[10px] text-gray-500 mt-1">
                            ${item.dim}cm × ${item.len}M
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-mono font-bold text-gray-600 text-sm">${item.area.toFixed(2)}m²</span>
                        <button onclick="removeDuctItem(${index})" class="text-gray-300 hover:text-red-500 p-1">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                `;
                body.appendChild(row);
            });

            const sheets37 = totalArea / 1.95;
            const sheets48 = totalArea / 2.97;

            document.getElementById('duct-total-area').innerText = totalArea.toFixed(2);
            document.getElementById('duct-total-3x7').innerText = Math.ceil(sheets37);
            document.getElementById('duct-total-4x8').innerText = Math.ceil(sheets48);
        }

        function removeDuctItem(index) {
            ductList.splice(index, 1);
            renderDuctList();
        }

        function clearDuctList() {
            if(confirm('確定要清空清單嗎？')) {
                ductList = [];
                renderDuctList();
            }
        }

        // --- 3. Airflow Logic ---
        let airMode = 'single'; // 'single' or 'multi'

        function initAir() {
            const rowsContainer = document.getElementById('air-multi-rows');
            rowsContainer.innerHTML = '';
            for(let i=0; i<3; i++) {
                addMultiRow(false); 
            }
        }

        function setAirMode(mode) {
            airMode = mode;
            const singleContent = document.getElementById('air-content-single');
            const multiContent = document.getElementById('air-content-multi');
            const btnSingle = document.getElementById('air-btn-single');
            const btnMulti = document.getElementById('air-btn-multi');

            if(mode === 'single') {
                singleContent.classList.remove('hidden');
                multiContent.classList.add('hidden');
                btnSingle.className = "flex-1 py-1.5 text-xs rounded-md bg-white text-sky-700 font-bold shadow-sm transition-all";
                btnMulti.className = "flex-1 py-1.5 text-xs rounded-md text-sky-100 hover:text-white transition-all";
            } else {
                singleContent.classList.add('hidden');
                multiContent.classList.remove('hidden');
                btnSingle.className = "flex-1 py-1.5 text-xs rounded-md text-sky-100 hover:text-white transition-all";
                btnMulti.className = "flex-1 py-1.5 text-xs rounded-md bg-white text-sky-700 font-bold shadow-sm transition-all";
            }
            calcAir();
        }

        function addMultiRow(doCalc = true) {
            const container = document.getElementById('air-multi-rows');
            const idx = container.children.length + 1;
            const div = document.createElement('div');
            div.className = "flex gap-2 items-center multi-row-item";
            div.innerHTML = `
                <span class="text-xs text-gray-400 w-4 text-center">${idx}</span>
                <input type="number" class="m-w w-16 p-2 border border-gray-300 rounded text-center text-xs" placeholder="W(cm)" oninput="calcAir()">
                <input type="number" class="m-h w-16 p-2 border border-gray-300 rounded text-center text-xs" placeholder="H(cm)" oninput="calcAir()">
                <input type="number" class="m-v flex-1 p-2 border border-gray-300 rounded text-center text-xs" placeholder="風速(m/s)" oninput="calcAir()">
                <div class="m-res w-16 text-right text-xs font-bold text-sky-700">0.0</div>
            `;
            container.appendChild(div);
            if(doCalc) calcAir();
        }

        function calcAir() {
            const isMax = document.getElementById('air-is-max').checked;
            const factorMsg = document.getElementById('air-factor-msg');
            let totalFlow = 0;

            if (airMode === 'single') {
                let area = parseFloat(document.getElementById('air-s-area').value) || 0;
                if(area === 0) {
                    const w = parseFloat(document.getElementById('air-s-w').value) || 0;
                    const h = parseFloat(document.getElementById('air-s-h').value) || 0;
                    area = (w * h) / 10000;
                }

                const inputs = document.querySelectorAll('.air-s-v');
                let vSum = 0, vCount = 0;
                inputs.forEach(i => {
                    const v = parseFloat(i.value);
                    if(!isNaN(v)) { vSum += v; vCount++; }
                });
                const vAvg = vCount > 0 ? vSum/vCount : 0;
                document.getElementById('air-s-avg').innerText = vAvg.toFixed(1);

                totalFlow = area * vAvg * 60;

                if(isMax) {
                    totalFlow *= 2;
                    factorMsg.classList.remove('hidden');
                    factorMsg.innerHTML = '<i class="fa-solid fa-check"></i> 已乘 2 倍 (最大一區)';
                } else {
                    factorMsg.classList.add('hidden');
                }

            } else {
                const rows = document.querySelectorAll('.multi-row-item');
                rows.forEach(row => {
                    const w = parseFloat(row.querySelector('.m-w').value) || 0;
                    const h = parseFloat(row.querySelector('.m-h').value) || 0;
                    const v = parseFloat(row.querySelector('.m-v').value) || 0;
                    
                    const area = (w*h)/10000;
                    const flow = area * v * 60;
                    
                    row.querySelector('.m-res').innerText = flow > 0 ? flow.toFixed(1) : '-';
                    totalFlow += flow;
                });

                if(isMax) {
                    factorMsg.classList.remove('hidden');
                    factorMsg.innerHTML = '<i class="fa-solid fa-info-circle"></i> 各區風量加總';
                } else {
                    factorMsg.classList.add('hidden');
                }
            }

            document.getElementById('air-final-flow').innerText = totalFlow.toFixed(1);
        }

        // --- 4. Motor Logic (Correction applied) ---
        // Data derived from 電動機額定電流表.pdf
        const motorData = {
            "1": { "220": 3.5, "380": 2.0, "440": 1.8 },
            "2": { "220": 6.5, "380": 3.8, "440": 3.2 },
            "3": { "220": 9, "380": 5.2, "440": 4.5 },
            "5": { "220": 15, "380": 8.7, "440": 7.5 },
            "7.5": { "220": 20, "380": 11.6, "440": 10 },
            "10": { "220": 27, "380": 15.6, "440": 13 },
            "15": { "220": 39, "380": 22.6, "440": 20 },
            "20": { "220": 50, "380": 29, "440": 25 },
            "25": { "220": 64, "380": 37, "440": 32 },
            "30": { "220": 78, "380": 45, "440": 39 },
            "35": { "220": 91, "380": 53, "440": 46 }, // Added missing 35HP
            "40": { "220": 100, "380": 58, "440": 50 },
            "50": { "220": 125, "380": 72, "440": 63 }
        };

        function getEstWire(amp) {
            // Estimates based on common CNS standards for pipe wiring (3 wires)
            if(amp <= 15) return "2.0mm² (1.6mm)";
            if(amp <= 20) return "3.5mm²";
            if(amp <= 30) return "5.5mm²";
            if(amp <= 40) return "8mm²";
            if(amp <= 55) return "14mm²";
            if(amp <= 75) return "22mm²";
            if(amp <= 95) return "30mm² ~ 38mm²";
            if(amp <= 120) return "38mm² ~ 50mm²";
            return "60mm² 或以上";
        }

        function lookupMotor() {
            const hp = document.getElementById('motor-hp').value;
            const v = document.getElementById('motor-v').value;
            const data = motorData[hp];
            
            if(data) {
                const amp = data[v];
                document.getElementById('motor-amp').innerText = amp;
                document.getElementById('motor-wire').innerText = getEstWire(amp);
            }
        }

        // Initialization
        initAir();
        lookupMotor();

    </script>
</body>
</html>